---
title: "R Notebook"
output: html_notebook
---

# Idiographic networks 

```{r Item selection}

# Select the top 6 features with the highests means and variability, excluding first misc columns (e.g., id, time)
clairecleans::item_sel(dat[which(colnames(dat) == "sleep"):ncol(dat)], 6) 

# subset your data based on items selected: 
# means data
dat_means <- dat[,c("ID", 
                    "ethica_time",
                    "ethica_time_utc", 
                    "lag", 
                    "tdif",
                    "cumsumT", 
                    "dayvar", 
                    "beepvar", 
                    "beepconsec", 
                    names.means)]
# variability data
dat_sd <- dat[,c("ID", 
                 "ethica_time", 
                 "ethica_time_utc", 
                 "lag", 
                 "tdif", 
                 "cumsumT", 
                 "dayvar", 
                 "beepvar", 
                 "beepconsec", 
                 names.sd)]

# save these dataframes 
name = paste0(id_name,"_means")
filename = paste(name, Sys.Date(), filetype, sep = '')
write.csv(dat_means, file = filename, row.names = FALSE)

name = paste0(id_name,"_sd")
filename = paste(name, Sys.Date(), filetype, sep = '')
write.csv(dat_sd, file = filename, row.names = FALSE)
```

```{r Stationarity and detrend}

##### means #####

vars <- names(dat_means)[-c(1:9)] 
(kpss_means <- clairecleans::kpss_df(dat_means, vars))

# visualize
x <- "beep" 
y <- colnames(dat_means)[-c(1:9)] 
design.matrix <- tidyr::expand_grid(x, y)

kpss_plot = function(x, y, df) {
    df$beep <- rep(1:nrow(df))
    ggplot(df, aes(x = .data[[x]], y = .data[[y]]) ) +
    geom_point() +
    geom_smooth(method = "lm", se = TRUE) +
    theme_bw() +
    coord_cartesian(ylim = c(0, 100)) +
    geom_text(aes(x = 27.5, y = 95, label=paste("KPSS Trend =",round(kpss.test(.data[[y]], null = "Trend")$statistic, digits = 3),", p = ",round(kpss.test(.data[[y]], null = "Trend")$p.value, digits = 3))), colour = "red1", size = 3, fontface = "bold", check_overlap = TRUE) + 
      theme(legend.title = element_blank())
}

(plot_grob <- plot_grid(arrangeGrob(grobs = pmap(design.matrix, ~kpss_plot(x = .x, y = .y, df= dat_means)))))

##### dickey-fuller #####
# resource: https://www.statology.org/dickey-fuller-test-in-r/
# sometimes KPSS test can be conservative. 
# The assumption is no unit root (not stationary), < .05 indicates stationarity

apply(dat_means[10:ncol(dat_means)], 2, adf.test) # doesn't like NAs

#### sd ####
vars <- names(dat_sd)[-c(1:9)] 
(kpss_sd <- clairecleans::kpss_df(dat_sd, vars))

# visualize
y <- colnames(dat_sd)[-c(1:9)] 
design.matrix <- tidyr::expand_grid(x, y)

(plot_grob <- plot_grid(arrangeGrob(grobs = pmap(design.matrix, ~kpss_plot(x = .x, y = .y, df = dat_sd)))))
# plots out of line

##### dickey-fuller #####
# apply(dat_sd[10:ncol(dat_sd)], 2, adf.test)

#### detrend ####

# This procedure is based off of the work of Aaron Fisher et al., (2017): Exploring the idiographic dynamics of mood and anxiety via network analysis https://osf.io/m63ks/ 
## Instead of applying a cubic spline, the night lag was dropped.

#### means ####
# trim
dat_m <- dat_means[,10:ncol(dat_means)]

dedatm <- data.frame(matrix(ncol = dim(dat_m)[2], nrow = dim(dat_m[1]))) 
# creating empty container to place detrended data

colnames(dedatm) <- colnames(dat_m) 

for(i in 1:ncol(dedatm)) {
  dedatm[,i] <- resid(lm(scale(dat_m[,i])~dat$cumsumT, na.action = na.exclude)) 
  }

dedatm <- bind_cols(dat[,7:8], dedatm)

#### SD ####

dat_sd <- dat_sd[,10:ncol(dat_sd)]
dedatsd <- data.frame(matrix(ncol = dim(dat_sd)[2], nrow = dim(dat_sd[1]))) # empty mat to fill with resid
colnames(dedatsd) <- colnames(dat_sd) # fix colnames

# detrend
for(i in 1:ncol(dedatsd)) {
  dedatsd[,i] <- resid(lm(scale(dat_sd[,i])~dat$cumsumT, na.action = na.exclude))
}

dedatsd <- bind_cols(dat[,7:8], dedatsd)
```

```{r Estimate means networks}
# use dat_means for not detrended and dedatm for detrended

dayvar <- "dayvar"
beepvar <- "beepvar"

# estimate network
NetMean <- graphicalVAR(dat_means, 
                        vars = names.means, 
                        dayvar = dayvar, 
                        beepvar = beepvar, 
                        gamma = 0, 
                        lambda_beta = 0, 
                        lambda_kappa = 0, 
                        verbose = FALSE)

# save graphs separately to make it easier for formatting later.
pdf("PR003_network_means_PCC.pdf", height = 5, width = 8)
pcc_m <- plot(NetMean, "PCC", labels = names.means, edge.labels = TRUE, layout = "spring")
dev.off()

pdf("PR003_network_means_PDC.pdf", height = 5, width = 8)
pdc_m <- plot(NetMean, "PDC", labels = names.means)
dev.off()

# create and save centrality plots
PR003_centplotm <- plot(NetMean, 
                        labels = names.means, 
                        edge.labels = TRUE, 
                        layout="spring") %>% 
  centralityPlot() +
  theme(legend.position = "none") +
  facet_grid(rows = vars(measure)) +
  theme(axis.text = element_text(size = 13),
        strip.text.y = element_text(size = 15))
ggsave(PR003_centplotm, filename = "PR003_centrality_m.png")

# centrality tables
# centr_m <- gather_cent(pcc_m, pdc_m)
# rm(centr)
write.csv(centr_m, "PR003_centr_means.csv", row.names = FALSE)

# node correlations. Get edge list and weights
(pcc_corr_m <- data.frame(pcc_m[[1]][[2]][[6]]))
write.csv(pcc_corr_m, "PR003_pcc_corr_means.csv", row.names = TRUE)

(pdc_corr_m <- data.frame(pdc_m[[1]][[2]][[5]]))
write.csv(pdc_corr_m, "PR003_pdc_corr_means.csv", row.names = TRUE)
```

```{r Estimate variability networks}
dayvar <- "dayvar"
beepvar <- "beepvar"

# use dat_sd for not detrended and dedatsd for detrended

# estimates network
NetSD <- graphicalVAR(dat_sd, 
                      vars = names.sd, 
                      dayvar = dayvar, 
                      beepvar = beepvar, 
                      gamma = 0, 
                      lambda_beta = 0, 
                      lambda_kappa = 0, 
                      verbose = FALSE)

# save graphs
pdf("PR003_network_sd_PCC.pdf", height = 5, width = 8)
pcc_sd <- plot(NetSD, "PCC", labels = names.sd, edge.labels = TRUE, layout="spring")
dev.off()

pdf("PR003_network_sd_PDC.pdf", height = 5, width = 8)
pdc_sd <- plot(NetSD, "PDC", labels = names.sd)
dev.off()

# create and save centrality plots
PR003_centplotsd <- plot(NetSD, labels = names.sd, 
                         edge.labels = TRUE, 
                         layout = "spring") %>% 
  centralityPlot() +
  theme(legend.position = "none") +
  facet_grid(rows = vars(measure)) +
  theme(axis.text=element_text(size=13),
        strip.text.y = element_text(size=15))
ggsave(PR003_centplotsd, filename = "PR003_centrality_sd.png")

# centrality tables
centr_sd <- gather_cent(pcc_sd, pdc_sd)
rm(centr)
write.csv(centr_sd, "PR003_centr_sd.csv", row.names = FALSE)

# node correlations
pcc_corr_sd <- data.frame(pcc_sd[[1]][[2]][[6]])
pcc_corr_sd # look at it
write.csv(pcc_corr_sd, "PR003_pcc_corr_sd.csv", row.names = TRUE)

pdc_corr_sd <- data.frame(pdc_sd[[1]][[2]][[5]])
pdc_corr_sd # look at it
write.csv(pdc_corr_sd, "PR003_pdc_corr_sd.csv", row.names = TRUE)
```

